\definecolor{Sail}{rgb}{0.643,0.819,0.976}
Este capítulo se centra en el diseño, simulación, construcción y la programación del sistema de medición y control, que en adelante se denominará \textit{datalogger}. En el mercado actual, existen equipos similares para la adquisición de datos y control, tales como el CR6 de Campbell Scientific \cite{cr6manual} y el DMU801 de Vaisala \cite{dmu801manual}. Sin embargo, su costo es elevado y presentan ciertas limitaciones para el desarrollo específico, ya que son sistemas cerrados y poseen menor flexibilidad. El \textit{datalogger} será empleado en un banco de medición para la calibración de anemómetros de ultrasonido, basado en la placa de desarrollo EDU-CIAA \cite{proyectoCIAA}. También se ha diseñado un \textit{shield} específico para esta aplicación, el cual será acoplado a la EDU-CIAA. 


\section{Desarrollo del hardware}\label{sec:desarrolloHardware}
Para el desarrollo del hardware, en una primera etapa se realizó un proceso de investigación de hojas de datos, manuales, artículos y videos de internet para ver qué módulos y componentes comprar para la implementación de la aplicación. Además, se utilizaron herramientas como LT Spice para la simulación de circuitos y KiCad para el diseño de PCB. El sistema se describe en la Figura \ref{fig:esquemaHardware} y consta de distintos módulos, a saber: un módulo para la adquisición de muestras de viento mediante el protocolo RS485, un módulo para la recepción y transmisión de datos a través de Ethernet, un módulo de alimentación de 12 \unit{\volt}, un módulo para tomar muestras de la tensión del variador del túnel de viento, un módulo de circuitos LEDs para indicar la recepción y estado; y un módulo PWM con una etapa de filtrado seguida de otra de amplificación para entregar la señal de control al túnel de viento. 
% Además, se toman muestras de esta señal y de la fuente para monitorear por software el comportamiento del sistema.


\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{Figuras/datalogger/esquemaHardware.png}
    \caption{Diagrama en bloques del sistema electrónico.}
    \label{fig:esquemaHardware}
\end{figure}



\subsection{Módulo principal}\label{sec:moduloPrincipal}
Para el módulo principal se utiliza placa de desarrollo EDU-CIAA-NXP, Figura \ref{fig:EduCiaaPlaca}, es una versión de bajo costo de la CIAA-NXP \cite{proyectoCIAA} pensada para la enseñanza universitaria, terciaria y secundaria. 
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Figuras/datalogger/Hardware/EduCiaaPlaca.jpg}
    \caption{Placa de desarrollo EDU CIAA}
    \label{fig:EduCiaaPlaca}
\end{figure}

% \begin{itemize}[leftmargin=*]

%   \item \textbf{Microcontrolador LPC4337:}
%     \begin{itemize}[label=-]
%       \item \textbf{Núcleos:} Dual-core ARM Cortex-M4/M0.
%       \item \textbf{Velocidad de reloj:} Hasta 204 MHz.
%       \item \textbf{Memoria RAM:} Hasta 264 KB.
%       \item \textbf{Memoria Flash:} Hasta 1 MB.
%     \end{itemize}

%   \item \textbf{Puertos micro-USB:}
%     \begin{itemize}[label=-]
%       \item Uno para aplicaciones y debugging (DEBUG).
%       \item Otro para alimentación (OTG).
%     \end{itemize}
  
%   \item \textbf{Salidas digitales:}
%     \begin{itemize}[label=-]
%       \item 4 salidas digitales implementadas con LEDs RGB.
%     \end{itemize}
  
%   \item \textbf{Entradas digitales:}
%     \begin{itemize}[label=-]
%       \item 4 entradas digitales con pulsadores.
%     \end{itemize}
  
%   \item \textbf{Comunicaciones RS485:}
%     \begin{itemize}[label=-]
%       \item Puerto de comunicaciones RS-485 con bornera.
%     \end{itemize}
  
%   \item \textbf{Conector de expansión P1:}
%     \begin{itemize}[label=-]
%       \item 3 entradas analógicas con 10 Bits de resolución cada uno (ADC0, 1, 2 y 3).
%       \item 1 salida analógica (DAC0).
%       \item 1 puerto I2C.
%       \item 1 puerto asincrónico full duplex (para RS-232).
%       \item 1 puerto CAN.
%       \item 1 conexión para un teclado de 3×4.
%     \end{itemize}
  
%   \item \textbf{Conector de expansión P2:}
%     \begin{itemize}[label=-]
%       \item 1 puerto Ethernet.
%       \item 1 puerto SPI.
%       \item 1 puerto para display LCD con 4 bits de datos, Enable y RS.
%       \item 9 pines genéricos de I/O.
%     \end{itemize}
    
% \end{itemize}
En la Figura \ref{fig:EDU_CIAA_esquema} se describe un diagrama en bloques de los perifericos de la placa de desarrollo.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.55\linewidth]{Figuras/datalogger/Hardware/EDUCIAAesquema.png}
    \caption{Diagrama en bloques de la EDU-CIAA}
    \label{fig:EDU_CIAA_esquema}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Módulo de alimentación}\label{sec:moduloAlimentacionElectrica}

Los anemómetros funcionan con una alimentación de 12 \unit{\volt} para el sistema principal y 24 \unit{\volt} para el sistema de calefacción, ya que estos sensores pueden ser expuestos a entornos con temperaturas por debajo de cero grados. Por otro lado, los módulos Ethernet, RS-485 y los amplificadores operacionales trabajan con 5 \unit{\volt}, mientras que el resto de la placa de desarrollo opera con 3,3 \unit{\volt}. Por esta razón, se decide alimentar todo el sistema con una fuente de 12 \unit{\volt}, para garantizar el funcionamiento de los anemómetros en condiciones normales de temperatura dentro del laboratorio. Para lograr estos niveles de tensión, se optó por un regulador basado en el chip LM2596S (Step-Down), como se indica en la Figura \ref{fig:StepDowmLM2596S}. Se conectan 12 \unit{\volt} a la entrada y se ajusta el potenciómetro hasta obtener 5 \unit{\volt} a la salida. Esta salida estará disponible para conectar el resto de los módulos. Cabe aclarar que, si bien la EDU-CIAA tiene una salida de 5 \unit{\volt}, esta no proporciona la corriente suficiente para alimentar todos los módulos, ya que está limitada por los 500 \unit{\milli\ampere} que entrega un puerto USB 2.0. En contraste, el regulador DC-DC basado en el LM2596 puede entregar hasta 3 \unit{\ampere}, satisfaciendo así las necesidades de corriente de todos los módulos conectados. 
% Todo el sistema tiene un consumo de -- \unit{\milli\ampere}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Figuras/datalogger/Hardware/StepDowmLM2596S.jpg}
    \caption{Regulador de tensión DC-DC basado en el chip LM2596.}
    \label{fig:StepDowmLM2596S}
\end{figure}

En la Figura \ref{fig:esquemPowerSupply} se observa el esquemático del sistema, donde se muestra cómo se conecta el módulo LM2596 con el resto de los componentes. Este esquemático incluye un divisor resistivo y un diodo Zener de 3,3 \unit{\volt} para limitar y adaptar la tensión de 12 \unit{\volt} a un rango de 3,3 \unit{\volt}, ya que se toman muestras de la tensión de alimentación a través del canal analógico-digital ADC\_CH1 de la EDU-CIAA. Esta información de la tensión se envía junto con los datos de los anemómetros, permitiendo un monitoreo en tiempo real del sistema de alimentación. Además, se han agregado filtros de \textit{bypass} a la alimentación del amplificador operacional LM358 para asegurar una operación estable y con bajo ruido.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{Figuras/datalogger/Hardware/esquemPowerSupply.png}
    \caption{Esquemático del sistema de alimentación con módulo LM2596, diodo Zener, divisor resistivo y filtros de bypass para el LM358.}
    \label{fig:esquemPowerSupply}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Módulo de adquisición}\label{sec:moduloAdquisicionDatoViento}
El SMN proporcionó los sensores de viento de ultrasonido. Se trabajó con los siguientes anemómetros: el modelo WMT700 de la marca VAISALA, Figura \ref{fig:sensorVaisala}
, utilizado como anemómetro patrón, y el modelo HD51.3D de la marca Delta OHM, Figura \ref{fig:sensorDeltaOhm}, utilizado como anemómetro bajo calibración. Ambos sensores operan con la interfaz eléctrica RS485 y vienen con un cable de aproximadamente 15 metros, puesto que estos sensores se instalan en torres de 10 metros de altura.

\begin{figure}[H]
    \centering
    
    \begin{minipage}[b]{0.45\textwidth}
        % \centering
        \subcaptionbox{\label{fig:sensorVaisala}}{\includegraphics[width=0.8\textwidth]{Figuras/datalogger/Hardware/sensorVaisala.jpg}}
    \end{minipage}
    \hspace{1em} % Espacio vertical entre las filas
    \begin{minipage}[b]{0.45\textwidth}
        \subcaptionbox{\label{fig:sensorDeltaOhm}}{\includegraphics[width=0.8\textwidth]{Figuras/datalogger/Hardware/sensorDeltaOhm.jpg}}
    \end{minipage}
    \caption{En (a) se muestra el sensor Vaisala modelo WMT700, en (b) se muestran el sensor Delta OHM modelo HD51.3D.}
    \label{fig:SensoresUtilizados}
\end{figure}

 Algunas especificaciones técnicas de este tipo de anemómetros se muestran en la tabla \ref{tab:especTecniDelta}. Las más relevantes para el proceso de calibración son, el rango de medición, la resolución, la precisión, los protocolos de comunicación, la alimentación eléctrica y el intervalo de tiempo mínimo con el que puede tomar muestras. En la sección \ref{sec:instrumentos_med_viento} del capítulo \ref{cap:viento} describimos los distintos tipos de sensores para medir la intensidad y dirección del viento. En particular se trabajó con anemómetros de ultrasonido cuya interfaz electrónica utiliza el protocolo RS-485 \cite{rs485Protocol}, el mismo es un protocolo diferencial ampliamente utilizado en entornos industriales debido a su robustez y confiabilidad. Utiliza tres cables (A, B y GND) y transmite datos mediante la diferencia de tensión entre A y B, ofreciendo alta inmunidad al ruido. En la Figura \ref{fig:rs485DeltaOhm} se muestra un esquema de conexión entre el sensor y el sistema. En particular, nos interesa dos cables para la alimentación V+ (12 \unit{\volt}) y V- (GND), y tres cables para los datos, DATA+ (A), DATA- (B) y GND. Puesto que tanto el sensor patrón como el sensor bajo calibración trabajan con el puerto RS485 y la placa de desarrollo EDU-CIAA cuenta con un solo puerto RS485, se va a utilizar un adaptador para asi tener disponible dos puertos RS485. 

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{Figuras/datalogger/Hardware/rs485DeltaOhm.png}
    \caption{Esquema de conexión de datos y alimentación del sensor HD51.3D con un \textit{Datalogger} o un PLC \cite{DeltaOHM_HD51.3D_manual}.}
    \label{fig:rs485DeltaOhm}
\end{figure}
En la Figura \ref{fig:rs485CIAA}, se muestra el puerto RS485 integrado de la EDU-CIAA, en esta bornera se conectó directamente el anemómetro patrón WMT700. El sensor envía datos en modo ráfaga cada segundo, y este puerto permite una comunicación directa sin necesidad de adaptadores adicionales.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.45\linewidth]{Figuras/datalogger/Hardware/rs485CIAA.jpg}
    \caption{Puerto RS-485 integrado en la EDU-CIAA}
    \label{fig:rs485CIAA}
\end{figure}

Para conectar el anemómetro bajo calibración se utilizó el módulo MAX485, Figura \ref{fig:moduleMax485}, que convierte las señales RS-485 a niveles de la UART (TTL). 
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Figuras/datalogger/Hardware/moduleMax485.png}
    \caption{Módulo convertidor de RS485 a UART (TTL)}
    \label{fig:moduleMax485}
\end{figure}

 El módulo se alimentó con 5 \unit{\volt} suministrados por el regulador LM2596S. Desde un extremo, se conectaron los cables A y B del sensor RS-485, mientras que del otro lado se conectó a la UART-RS232 de la EDU-CIAA. Para adaptar la señal TTL a la placa de desarrollo, se utilizó un resistor de 1 \unit{\kilo\ohm} entre el pin RO del MAX485 y el pin Rx de la UART-RS232. Los pines DE y RE del MAX485 se conectaron a GND para permitir la recepción de datos desde el sensor hacia la placa. El pin DI no se conectó, ya que el sensor no requiere recibir datos o comandos desde la EDU-CIAA.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Figuras/datalogger/Hardware/esquemRS485.png}
    \caption{Esquemático del módulo MAX485 para la recepción de datos del sensor bajo calibración.}
    \label{fig:esquemRS485}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Explicar el protocolo y tensiones de los anemometros
% Poner un esquema de módulo y como va conectado a la CIAA
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Módulo de comunicación}\label{sec:moduloEthernet}

Para comunicar el sistema embebido con distintos servidores, como el servidor \textit{WebSocket} desarrollado en la sección \ref{sec:back_end}, así como servidores NTP para sincronizar la fecha y hora, se utilizó el módulo W5100, Figura \ref{fig:moduleW5100}. Este módulo emplea el protocolo TCP/IP para proporcionar una comunicación estable. Se alimenta con 5 \unit{\volt} y utiliza una interfaz SPI para comunicarse con la placa de desarrollo. Una de las principales ventajas del módulo W5100 \cite{W5100Datasheet} es su capacidad para manejar cuatro \textit{sockets} independientes, lo que permite conectarse con hasta cuatro servidores distintos de manera concurrente. Esto mejora la eficiencia y la flexibilidad del sistema, facilitando la integración con múltiples servicios de red simultáneamente.



\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{Figuras/datalogger/Hardware/moduleW5100.png}
    \caption{Módulo W5100 utilizado para realizar la conectividad a una red o internet a través de la interfaz SPI del microcontrolador.}
    \label{fig:moduleW5100}
\end{figure}
% Descripción de los Pines del Módulo W5100 Ethernet
% \begin{itemize}
% \item \textbf{VCC:} Pin de alimentación, generalmente conectado a $\SI{3.3}{\volt}$ o $\SI{5}{\volt}$, dependiendo del módulo específico.
% \item \textbf{GND:} Pin de tierra, utilizado para completar el circuito de alimentación.
% \item \textbf{MISO (Master In Slave Out):} Pin de salida de datos del módulo hacia el microcontrolador en la comunicación SPI.
% \item \textbf{MOSI (Master Out Slave In):} Pin de entrada de datos desde el microcontrolador hacia el módulo en la comunicación SPI.
% \item \textbf{SCK (Serial Clock):} Pin de reloj serial utilizado para sincronizar la comunicación SPI.
% \item \textbf{SS (Slave Select):} Pin utilizado por el microcontrolador para seleccionar el módulo W5100 como dispositivo esclavo en la comunicación SPI.
% \item \textbf{RST (Reset):} Pin de reinicio, utilizado para reiniciar el módulo.
% \item \textbf{P+ y P-:} Pines para Power over Ethernet (PoE), utilizados para suministrar energía al dispositivo a través del cable Ethernet.
% \end{itemize}

Como se muestra en la Figura \ref{fig:esquemEthernet}, el módulo W5100 se alimentó con 5 \unit{\volt} y se conectaron los pines del módulo a la EDU-CIAA de la siguiente manera: el pin MO a SPI\_MOSI, el pin MI a SPI\_MISO, y el pin SCK a SPI\_SCK. Además, se conectó el pin NSS al GPIO1 para poder reiniciar el módulo cuando sea necesario por software. El resto de los pines del módulo quedaron sin conectar. Con esta configuración, se logró una comunicación bidireccional, permitiendo transmitir datos de los sensores de viento desde el \textit{datalogger} hacia la aplicación Web, así como recibir comandos desde la aplicación Web hacia el \textit{datalogger}.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Figuras/datalogger/Hardware/esquemEthernet.png}
    \caption{Esquemático del módulo W5100 para la comunicación bidireccional con distintos servidores.}
    \label{fig:esquemEthernet}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Módulo de control}\label{sec:circuitoPWM}


En esta sección, se presenta el desarrollo de un circuito que permite controlar la potencia del motor del túnel de viento a través de modulación por ancho de pulso (PWM, por sus siglas en inglés). Primero, se describe el funcionamiento original del variador de velocidad. En la Figura \ref{fig:esquemCircuitoControlTunel} se muestra un esquema del tablero de control que se conecta con el variador de velocidad del túnel de viento. El tablero posee dos pulsadores: uno de marcha (BT1-NC) y otro de parada (BT2-NA), que permiten encender y apagar, respectivamente, el conjunto variador-motor del túnel de viento. La velocidad del viento se regula manualmente mediante dos potenciómetros lineales: $P_{1} = \SI{1}{\kilo\ohm}$ y $P_{2} = \SI{500}{\ohm}$. Además, el circuito incluye una resistencia $R_{1} = \SI{1.2}{\kilo\ohm}$ conectada a una fuente de alimentación $V_{CC} = \SI{10}{\volt}$ que es proporcionada por el tablero. Estos componentes, junto con los potenciómetros, conforman un divisor de tensión variable que permite ajustar la tensión en un rango de \SI{0}{\volt} a \SI{10}{\volt}. Esta tensión se aplica al pin de entrada analógico-digital $V_{ADC}$ del tablero. Este nivel de baja tensión obtenido se amplifica y adapta a través de su variador a los niveles de tensión continua requeridos por el motor en el rango de \SI{0}{\volt} a \SI{300}{\volt}. El nivel de tensión aplicado al motor se puede visualizar en un voltímetro de corriente continua, \textit{V}, que incluye el tablero.

Se realizó una medición con un amperímetro en serie con la resistencia $R_{1}$ y se obtuvo que la corriente sobre $R_{1}$ cuando se ajusta el potenciómetro para obtener una $V_{ADC} = \SI{3.56}{\volt}$ es de \SI{140}{\micro\ampere}. Cuando se ajusta el potenciómetro para obtener una $VADC = \SI{5}{\volt}$, la corriente es de \SI{200}{\micro\ampere}. Con estas mediciones podemos concluir que el pin $V_{ADC}$ del variador tiene una resistencia de entrada de alta impedancia, ya que el consumo de corriente no supera los \SI{500}{\micro\ampere}.


\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\linewidth]{Figuras/datalogger/Hardware/esquemCircuitoControlTunel.png}
    \caption{Esquemático circuital del tablero de control del tunel de viento.}
    \label{fig:esquemCircuitoControlTunel}
\end{figure}

Para lograr controlar el nivel de tensión $V_{ADC}$ por medio de software, se remplazó los dos potenciómetros y el resistor $R_{1}$ por un circuito diseñado en la siguiente sección. Por otro lado, se hizo un relevamiento de la corriente máxima que puede entregar la fuente del variador $V_{CC}$ conectando distintos valores de resistencia entre $V_{CC}$ y $GND$. Los resultados se muestran en la tabla \ref{tab:currentVccVariador}. Como se observa en la tabla, a medida que disminuimos la carga $R$ de prueba, tanto la tensión, como la corriente que puede entregar la fuente $V_{CC}$ disminuyen. Se alcanza la corriente maxima de $\SI{100}{\milli\ampere}$ a partir de una carga de $\SI{100}{\ohm}$, cuya tension de la fuente cae a $\SI{2.29}{\volt}$. Tomando como referencia el consumo de corriente y la tensión que precisa el \textit{datalogger}, esta fuente $V_{CC}$ del tablero, no es capaz de suministrar la corriente necesaria y mantener la tensión constante, por esta razón se optó por alimentar el sistema como se explicó en la sección \ref{sec:moduloAlimentacionElectrica}



\begin{table}[H]
\centering
\fontsize{10}{8}\selectfont
\begin{tblr}{
  cells = {c},
  row{1} = {Sail},
  hlines,
  vlines,
}
\textbf{R [\unit{\ohm}]} & \textbf{VCC [\unit{\milli\volt}]} & \textbf{I\_R[\unit{\milli\ampere}]} \\
47K              & 9,9               & 2               \\
10K              & 9,52              & 5,9               \\
1K               & 9,29              & 9,4               \\
560              & 7,55              & 13,48             \\
330              & 5,63              & 16,97             \\
100              & 2,29              & 100               \\
47               & 0,859               & 100               
\end{tblr}
\caption{Mediciones de tensión y corriente de la fuente del variador para distintas resistencias de carga.}
\label{tab:currentVccVariador}
\end{table}

\subsubsection{Simulación del circuito}\label{simulacionCircuito}

En la Figura \ref{fig:pwmCircuitSimulate} se presenta el diseño del circuito del PWM \cite{EEVblog225}, el cual reemplaza al divisor de tensión compuesto por los potenciómetros $P_{1}$, $P_{2}$ y la resistencia $R_{1}$, mostrado en la Figura \ref{fig:esquemCircuitoControlTunel}. La señal de entrada es una señal PWM (cuadrada), que en la simulación se obtiene mediante la fuente \textit{Pulse}, mientras que en la implementación del circuito se obtendrá desde un pin de la EDU-CIAA. Esta señal, para un ciclo de trabajo del $100\%$, tiene una amplitud de $\SI{3.3}{\volt}$, acorde con los niveles digitales de tensión de la EDU-CIAA. Posteriormente, esta señal pasa por dos etapas de filtrado, cada una con una frecuencia de corte de $\SI{1592}{\hertz}$. En la Figura \ref{fig:filter1and2} se muestra la tensión de la primera etapa del filtro pasabajo, $\text{vFilter1}$ (señal verde), que tiene un tiempo de crecimiento corto, del orden de $\SI{8}{\milli\second}$, pero presenta mayor rizado. La segunda etapa del filtro genera la tensión $\text{voutFilter}$ (señal azul), que tiene un mayor tiempo de crecimiento, del orden de $\SI{12}{\milli\second}$, pero con un rizado mucho menor. Con esta doble etapa de filtro pasabajo, se obtiene una señal continua, estable, controlada por PWM.


Posteriormente, la señal rectificada ingresa a una etapa de amplificación no inversora, implementada con el amplificador operacional LM358. Este nivel de continua es el que se conecta al pin $V_{ADC}$ del variador de velocidad del túnel de viento, pero para la simulación esta entrada se reemplaza con una carga de $\SI{1}{\mega\ohm}$. La señal a la salida del amplificador tiene una ganancia de $\frac{\SI{3.5}{\volt}}{\SI{3.3}{\volt}} \approx \SI{1.06}{}$. Se decidió amplificar hasta $\SI{3.5}{\volt}$ porque realizando pruebas con una fuente de laboratorio, se encontró que la máxima velocidad que logra alcanzar el túnel, de $\SI{25}{\meter\per\second}$, se alcanza con $\SI{3.5}{\volt}$ a la entrada del $V_{ADC}$. Esta limitación viene dada por la mecánica del motor, por lo tanto, en estas condiciones no es necesario amplificar a valores mayores de $\SI{3.5}{\volt}$, ya que el túnel no incrementa su velocidad de viento.

% No obstante, para cuando se mejore la mecánica y transmisión del motor del túnel de viento, se dejó un resistor variable (Preset) $R3=\SI{10}{\kilo\ohm}$. Con este preset se cambia la ganancia del amplificador. Se lo ajustó para alcanzar $\SI{3.5}{\volt}$ a la salida del operacional, y podrá ser recalibrado para alcanzar mayores niveles de tensión, lo que genera, mayores velocidades de viento.


\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/pwmCircuitSimulate.png}
    \caption{Circuito diseñado para obtener distintos niveles de tensión mediante la variación del ciclo de trabajo de una señal cuadrada (PWM).}
    \label{fig:pwmCircuitSimulate}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/filter1and2.png}
    \caption{Señales a la salida del primer filtro LP (curva verde) y segundo filtro LP (curva azul).}
    \label{fig:filter1and2}
\end{figure}

Se dejó un resistor variable (Preset) $R_{3}=\SI{10}{\kilo\ohm}$ para poder modificar la ganancia del amplificador si fuera necesario. En este caso se lo ajustó para alcanzar $\SI{3.5}{\volt}$ a la salida del operacional. Sin embargo, para cuando sea mejorada la mecánica y transmisión del motor del túnel de viento, podrá ser recalibrado para llegar a mayores niveles de tensión, y por ende mayores velocidades de viento.

En la Figura \ref{fig:pwm100Percent} se muestra el resultado de la simulación para un pulso $\text{vPWM}$ (señal verde) de $\SI{100}{\micro\second}$ de periodo ($\SI{10}{\kilo\hertz}$) y una amplitud de $\SI{3.3}{\volt}$ con un ciclo de trabajo del $100\%$. La señal $\text{vOutFilter}$ (señal en azul) es la que ingresa al amplificador operacional alcanzando su valor máximo en $\SI{3.3}{\volt}$ y la señal $\text{vAdcTunnel}$ (señal en rojo) se mide a la salida del amplificador operacional alcanzando un tension máxima de $\SI{3.5}{\volt}$ lo que produce la máxima velocidad del motor.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/pwm100Percent.png}
    \caption{Señales simuladas para un ciclo de trabajo del 100 \%.}
    \label{fig:pwm100Percent}
\end{figure}
En la simulación, al regular el ciclo de trabajo de la señal de entrada, se obtuvieron distintos niveles de tensión continua. Esto se puede observar en las Figuras \ref{fig:pwm75Percent} y \ref{fig:pwm55Percent}, que muestran los resultados para ciclos de trabajo del $75\%$ y $55\%$, respectivamente.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/pwm75Percent.png}
    \caption{Señales simuladas para un ciclo de trabajo al 75 \% de la señal de entrada.}
    \label{fig:pwm75Percent}
\end{figure}



\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/pwm55Percent.png}
    \caption{Señales simuladas para un ciclo de trabajo al 55 \% de la señal de entrada.}
    \label{fig:pwm55Percent}
\end{figure}


\subsubsection{Desarrollo del circuito}

Se implementó el circuito de la Figura \ref{fig:pwmCircuitSimulate} en un \textit{protoboard} de prueba con componentes \textit{Through-Hole Technology} (THT), conectado a la EDU-CIAA, como se muestra en la Figura \ref{fig:BancoMedicion1}. Para comprobar y caracterizar el comportamiento del PWM, se utilizaron distintos valores de nivel de PWM programados desde el firmware del microcontrolador. El nivel de PWM de la señal cuadrada se modificó desde 1 hasta 255, equivalente a un ciclo de trabajo de  0\% a 100\%.

Para realizar estas mediciones, se utilizó un osciloscopio RIGOL DS2302A. En el canal 1 se midió la señal PWM que sale de un pin digital de la placa de desarrollo y se conecta a la entrada del circuito PWM, esta señal tiene una frecuencia de $\SI{10}{\kilo\hertz}$ con amplitud de $\SI{3.3}{\volt}$ . En el canal 2 se midió la señal continua a la salida del amplificador operacional, ajustando el potenciómetro $R_{3}$ (variable) del esquema de la Figura \ref{fig:pwmCircuitSimulate}, para obtener $\SI{3.5}{\volt}$ cuando el ciclo de trabajo es $100\%$.

% \begin{figure}[H]
%     \centering
%     \includegraphics[width=1.1\linewidth]{Figuras/datalogger/Hardware/esquemPWM.png}
%     \caption{Esquemático del circuito PWM que controla la velocidad del túnel de viento por programación.}
%     \label{fig:esquemPWM}
% \end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/BancoMedicion1.jpg}
    \caption{Banco de medición para caracterizar el circuito PWM.}
    \label{fig:BancoMedicion1}
\end{figure}

Los resultados de las mediciones realizadas con el osciloscopio se muestran en las Figuras \ref{fig:1}, \ref{fig:63}, \ref{fig:127}, \ref{fig:191} y \ref{fig:255}, equivalente a ciclo de trabajo de 1\%, 25\%, 50\%, 75\% y 100\% respectivamente.



\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Figuras/datalogger/Hardware/MedicionesPWM/1.png}
    \caption{Medición de la señal PWM (rojo) con un ciclo de trabajo de (1\%) y la señal continua a la salida del amplificador operacional (azul) iguala $\SI{53.5}{\milli\volt}$.}
    \label{fig:1}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Figuras/datalogger/Hardware/MedicionesPWM/63.png}
    \caption{Medición de la señal PWM (rojo) con un ciclo de trabajo de (25\%) y la señal continua a la salida del amplificador operacional (azul) iguala $\SI{900}{\milli\volt}$.}
    \label{fig:63}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Figuras/datalogger/Hardware/MedicionesPWM/127.png}
    \caption{Medición de la señal PWM (rojo) con un ciclo de trabajo de (50\%) y la señal continua a la salida del amplificador operacional (azul) iguala $\SI{1.8}{\volt}$. }
    \label{fig:127}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Figuras/datalogger/Hardware/MedicionesPWM/191.png}
    \caption{Medición de la señal PWM (rojo) con un ciclo de trabajo de (75\%) y la señal continua a la salida del amplificador operacional (azul) iguala $\SI{2.65}{\volt}$.}
    \label{fig:191}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Figuras/datalogger/Hardware/MedicionesPWM/255.png}
    \caption{Medición de la señal PWM (rojo) con un ciclo de trabajo de (100\%) y la señal continua a la salida del amplificador operacional (azul) iguala $\SI{3.56}{\volt}$.}
    \label{fig:255}
\end{figure}
Luego de caracterizar el circuito PWM, se dio comienzo a las pruebas en el túnel de viento. Se conectó la tensión de la salida del operacional al pin de entrada $V_{ADC}$ del variador de velocidad. A continuación, se realizó un barrido del nivel de PWM desde 0 hasta 255 (0\% a 100\%), midiendo con un voltímetro, UNI-T modelo UT89X, la tensión entregada al túnel y, con el anemómetro VAISALA WMT700 dentro del túnel, la velocidad en metros por segundo obtenida para cada nivel de PWM. En la Figura \ref{fig:pruebaTunelCicloAsc} se muestran los resultados de un barrido ascendente, y en la Figura \ref{fig:pruebaTunelCicloDes}, los resultados de un barrido descendente.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/MedicionesPWM/pruebaTunelCicloAsc.png}
    \caption{Mediciones para niveles de PWM en modo Ascendente, del nivel de tensión en el variador y la velocidad de viento.}
    \label{fig:pruebaTunelCicloAsc}
\end{figure}

% \begin{table}[H]
% \centering
% \fontsize{10}{8}\selectfont
% \begin{tblr}{
%   cells = {c},
%   row{1} = {Sail},
%   hlines,
%   vlines,
% }
% {\textbf{Ciclo de trabajo}\\\textbf{[0 - 255]}} & \textbf{VadcTunnel [\unit{\milli\volt}]} & \textbf{Viento [\unit{\meter\per\second}]} \\
% 0                                                & 4,2                      & 1                     \\
% 1                                                & 16,6                     & 1,1                   \\
% 2                                                & 30,3                     & 1,2                   \\
% 31                                               & 427                      & 4,5                   \\
% 63                                               & 864                      & 7,8                   \\
% 94                                               & 1291                     & 11,1                  \\
% 127                                              & 1745                     & 14,7                  \\
% 158                                              & 2170                     & 18                    \\
% 191                                              & 2621                     & 21,5                  \\
% 222                                              & 3048                     & 24,5                  \\
% 255                                              & 3500                     & 26,3                  
% \end{tblr}
% \caption{Mediciones para ciclos de trabajo en modo Ascendente, VadcTunnel y la velocidad del viento.}
% \label{tab:windSpeedDataAsc}
% \end{table}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/MedicionesPWM/pruebaTunelCicloDes.png}
    \caption{Mediciones para niveles de PWM en modo descendente, del nivel de tensión en el variador y la velocidad de viento.}
    \label{fig:pruebaTunelCicloDes}
\end{figure}

% \begin{table}[H]
% \centering
% \fontsize{10}{8}\selectfont
% \begin{tblr}{
%   cells = {c},
%   row{1} = {Sail},
%   hlines,
%   vlines,
% }
% {\textbf{Ciclo de trabajo}\\\textbf{[0 - 255]}} & \textbf{VadcTunnel [\unit{\milli\volt}]} & \textbf{Viento [\unit{\meter\per\second}]} \\
% 255                               & 3501                     & 25,9                  \\
% 222                               & 3048                     & 24,5                  \\
% 191                               & 2622                     & 21,3                  \\
% 158                               & 2170                     & 18                    \\
% 127                               & 1744                     & 14,7                  \\
% 94                                & 1291                     & 11,1                  \\
% 63                                & 865                      & 7,8                   \\
% 31                                & 426                      & 4,5                   \\
% 2                                 & 30                       & 1,3                   \\
% 1                                 & 16                       & 1,1                   \\
% 0                                 & 4                        & 1,0                   
% \end{tblr}
% \caption{Mediciones para ciclos de trabajo en modo Descendente, VadcTunnel y la velocidad del viento.}
% \label{tab:windSpeedDataDesc}
% \end{table}

A partir de los resultados obtenidos para la tensión en el variador y la velocidad del viento medida con el anemómetro versus el nivel de PWM

, se determina una velocidad máxima de viento de $\SI{26}{\meter\per\second}$ para una tensión de $\SI{3.5}{\volt}$. Además, dado que se tienen 255 niveles de tensión, y considerando que tanto el viento como la tensión $V_{ADC}$ del variador tienen respuesta lineal en el rango de 0 a 255, se obtiene una resolución en tensión de $\frac{\SI{3.5}{\volt}}{255} = \SI{13.7}{\milli\volt}$ y una resolución en velocidad del viento de $\frac{\SI{26}{\meter\per\second}}{255} = \SI{0.101}{\meter\per\second}$. Con estas mediciones y la caracterización del circuito PWM, éste quedó listo para ser integrado en un PCB. Este circuito será la interfaz electrónica para un controlador PID, el cual se explica en la sección \ref{sec:sistemaDeControlPid}.


% \subsubsection{Caracterizacion en el tunel de viento}
% Aca poner las mediciones y pruebas que se hicieron en el tunel, las tablas de Click up
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Módulo de tensión}\label{sec:adquisicionVadcTunel}

En esta sección se describe el diseño de un circuito que permite tomar muestras de la tensión entregada al variador del túnel de viento. El circuito funciona como un voltímetro que mide la tensión instantánea y la envía a un canal analógico-digital (ADC\_CH2) de la EDU-CIAA. 

Debido a que la señal de continua, para un ciclo de trabajo del 100\%, es de $\SI{3.5}{\volt}$, fue necesario adaptar esta señal a $\SI{3.3}{\volt}$, ya que esta es la tensión máxima de entrada para los canales ADC de la EDU-CIAA.

\subsubsection{Simulación del circuito}

En la Figura \ref{fig:adcCiaaCircuitSimulate} se muestra el diseño del circuito, la señal de continua $\text{VadcTunnel}$ se conecta al segundo operacional del chip LM358, en modo seguidor para adaptar la impedancia y no cargar a la etapa anterior, luego a la salida del operacional se conecta un divisor de tensión para adaptar la tensión a $\SI{3.3}{\volt}$, además se agrega una etapa de protección con dos diodos conectados entre la fuente de $\SI{3.3}{\volt}$ y GND para limitar la tensión en caso de que la tensión a la salida del operacional sea superior  $\SI{3.3}{\volt}$. Finalmente, se pone una resistencia de $\SI{1}{\kilo\ohm}$ para limitar la corriente en  $\text{VadcCIAA}$ y para simular la resistencia de entrada del ADC, agregamos un resistor de $\SI{1.2}{\mega\ohm}$ \cite{LPC435x_datasheet}.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/adcCiaaCircuitSimulate.png}
    \caption{Circuito diseñado para tomar muestras de la señal que se suministra al variador de velocidad y se las envía a una canal analógico-digital de la EDU-CIAA.}
    \label{fig:adcCiaaCircuitSimulate}
\end{figure}
Los resultados de la simulación del circuito descrito, se muestran en la Figura \ref{fig:adc100PercentPwm} para un ciclo de trabajo del $100\%$ y en la Figura \ref{fig:adc55PercentPwm} para un ciclo de trabajo del $55\%$. En ambos casos, se puede apreciar que la señal $\text{vadcCIAA}$ (verde) está por debajo de la señal $\text{vadcTunel}$ (azul), lo cual garantiza que no se superen los $\SI{3.3}{\volt}$ a la entrada del pin analógico-digital de la placa de desarrollo.


\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/adc100PercentPwm.png}
    \caption{Señales simuladas a la salida del variador de velocidad y a la entrada del pin analógico-digital de la EDU-CIAA para un ciclo de trabajo del 100\%.}
    \label{fig:adc100PercentPwm}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/adc55PercentPwm.png}
    \caption{Señales simuladas a la salida del variador de velocidad y a la entrada del pin analógico-digital de la EDU-CIAA para un ciclo de trabajo del 55\%.}
    \label{fig:adc55PercentPwm}
\end{figure}

\subsubsection{Desarrollo del circuito}

Se implementó el circuito de la Figura \ref{fig:adcCiaaCircuitSimulate}. Para ajustar los niveles de tensión de $\SI{3.5}{\volt}$ a $\SI{3.3}{\volt}$, se agregó en el divisor de tensión, un resistor variable con un \textit{preset} de $R_{5} = \SI{10}{\kilo\ohm}$. Luego se conectó los diodos Schottky 1N5819 \cite{1N5819_datasheet} a la fuente de $\SI{3.3}{\volt}$ de la EDU-CIAA y se agregó un la resistencia limitadora de tensión de $R_{7} = \SI{1}{\kilo\ohm}$, esta señal de continua se muestrea con una resolución  de $\frac{\SI{3.3}{\volt}}{1024} = \SI{3.22}{\milli\volt}$  en el canal ADC\_CH2 de la placa de desarrollo.

% \begin{figure}[H]
%     \centering
%     \includegraphics[width=1.1\linewidth]{Figuras/datalogger/Hardware/esquemADCTunel.png}
%     \caption{Esquemático de la implementación del circuito que toma muestras de la señal continua que ingresa al variador de velocidad.}
%     \label{fig:esquemADCTunel}
% \end{figure}

Por ultimo, para caracterizar este circuito se conectó dos voltímetros, uno en la señal de entrada del variador y otro en la señal que ingresa al ADC de la EDU-CIAA, los resultados de estas mediciones se observan en las Figura \ref{fig:pruebaTunelCiaaAsc} para un barrido ascendente y \ref{fig:pruebaTunelCiaaDes} para un barrido descendente.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/MedicionesPWM/pruebaTunelCiaaAsc.png}
    \caption{Mediciones a la entrada pin $V_{ADC}$ del variador y en el pin ADC\_CH2 de la EDU-CIAA, para un barrido ascendente  del nivel de PWM.}
    \label{fig:pruebaTunelCiaaAsc}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/MedicionesPWM/pruebaTunelCiaaDes.png}
    \caption{Mediciones a la entrada pin $V_{ADC}$ del variador y en el pin ADC\_CH2 de la EDU-CIAA, para un barrido descendente del nivel de PWM.}
    \label{fig:pruebaTunelCiaaDes}
\end{figure}
% \begin{table}[H]
% \centering
% \fontsize{10}{8}\selectfont
% \begin{tblr}{
%   cells = {c},
%   row{1} = {Sail},
%   hlines,
%   vlines,
% }
% {\textbf{Ciclo de trabajo }\\\textbf{[0 - 255]}} & \textbf{VadcTunnel [\unit{\milli\volt}]} & \textbf{VadcCIAA [\unit{\milli\volt}]} \\
% 0                                                & 4,2                      & 20                        \\
% 1                                                & 16,6                     & 16,7                      \\
% 2                                                & 30,3                     & 37,3                      \\
% 31                                               & 427                      & 421,3                     \\
% 63                                               & 864                      & 856                       \\
% 94                                               & 1291                     & 1280                      \\
% 127                                              & 1745                     & 1725                      \\
% 158                                              & 2170                     & 2146                      \\
% 191                                              & 2621                     & 2593                      \\
% 222                                              & 3048                     & 3013                      \\
% 255                                              & 3500                     & 3364                      
% \end{tblr}
% \caption{Mediciones a la entrada pin $VADC$ del variador y en el pin ADC\_CH2 de la EDU-CIAA, para un barrido ascendente  del ciclo de trabajo.}
% \label{tab:medicionesVadcCIAA_ascendente}
% \end{table}



% \begin{table}[H]
% \centering
% \fontsize{10}{8}\selectfont
% \begin{tblr}{
%   cells = {c},
%   row{1} = {Sail},
%   hlines,
%   vlines,
% }
% {\textbf{Ciclo de trabajo }\\\textbf{[0 - 255]}} & \textbf{VadcTunnel [\unit{\milli\volt}]} & \textbf{VadcCIAA [\unit{\milli\volt}]} \\
% 255                                              & 3501                     & 3364                    \\
% 222                                              & 3048                     & 3012                    \\
% 191                                              & 2622                     & 2593                    \\
% 158                                              & 2170                     & 2146                    \\
% 127                                              & 1744                     & 1725                    \\
% 94                                               & 1291                     & 1277                    \\
% 63                                               & 865                      & 855                     \\
% 31                                               & 426                      & 422                     \\
% 2                                                & 30                       & 38                      \\
% 1                                                & 16                       & 27                      \\
% 0                                                & 4                        & 21                      
% \end{tblr}
% \caption{Mediciones a la entrada pin $VADC$ del variador y en el pin ADC\_CH2 de la EDU-CIAA, para un barrido descendente del ciclo de trabajo.}
% \label{tab:medicionesVadcCIAA_descendente}
% \end{table}
Este circuito permite monitorear por software los niveles de tensión que estamos entregando al variador de velocidad y su correspondiente nivel de PWM.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Módulo de LEDs}
Se diseñó el circuito de la Figura \ref{fig:esquemLedsSensor}  para encender y apagar LEDs como indicadores de la recepción de datos de los anemómetros patrón y bajo calibración. Se utilizaron dos LEDs de colores diferentes: uno verde y otro amarillo. El LED verde se asoció al canal RS-485-1 y el LED amarillo al canal RS-485-2. Cada circuito permite que el LED correspondiente parpadee cada vez que se recibe un dato del anemómetro, con un intervalo predeterminado por software. Si el LED no parpadea, indica que el anemómetro no está enviando datos.% Por el contrario, si el LED parpadea, confirma la recepción de datos del anemómetro.

% El diseño de cada circuito incluye un transistor NPN y dos resistencias, conectados a un diodo LED. La señal de entrada llega al resistor $ R_4 = \SI{1}{\kilo\ohm} $, el cual está conectado a la base del transistor. El colector del transistor está conectado a una fuente de $\SI{5}{\volt} $, mientras que el emisor está conectado a una resistencia limitadora de corriente $ R5 = \SI{39}{\ohm}$ y luego al ánodo del LED, con su cátodo a masa. Ambos circuitos son prácticamente idénticos, diferenciándose únicamente en los colores de los LEDs y los canales RS-485 a los que están conectados.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\linewidth]{Figuras/datalogger/Hardware/esquemLedsSensor.png}
    \caption{Esquemático de los circuitos que encienden y apagan dos LEDs, verde y amarillo, cada vez que se recibe un dato de los anemómetros, tanto del patrón como del que está bajo calibración.}

    \label{fig:esquemLedsSensor}
\end{figure}

En La Figura \ref{fig:esquemLedStatusSocket} se muestra un circuito similar al previamente descrito, en el que se utiliza un LED dual como indicador de la conectividad del sistema de la placa de desarrollo con el servidor \textit{WebSocket} descrito en la sección \ref{sec:back_end}. El LED dual se enciende en rojo cuando el sistema de la placa de desarrollo está desconectado del servidor. Al establecerse la conexión a través de Ethernet, el LED cambia a verde. Este cambio de color ocurre automáticamente según el estado de la conectividad con el servidor. El LED dual tiene tres pines: dos ánodos y un cátodo común conectado a masa. Los ánodos están conectados a circuitos que controlan el encendido y apagado del LED según las señales de los pines digitales de la placa de desarrollo.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Figuras/datalogger/Hardware/esquemLedStatusSocket.png}
    \caption{Esquemático del circuito de un LED dual que se enciende en rojo cuando el sistema no está conectado al servidor \textit{WebSocket} y en verde cuando hay una conexión estable con el servidor.}
    \label{fig:esquemLedStatusSocket}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Diseño y construcción del PCB}

En las secciones anteriores se ha descrito el diseño y funcionamiento electrónico de los distintos módulos y circuitos que forman parte del \textit{datalogger}. Para integrar todo en un solo lugar, se diseñó un \textit{shield} que se conecta sobre la EDU-CIAA. Para ello, se trabajó con la lista de templates que ofrece el proyecto CIAA \cite{CIAA_Ponchos}. Este template tiene un diseño acorde con las dimensiones de la placa EDU-CIAA. Para el desarrollo del PCB, se utilizó el software KiCad. Primero se cargó el template de la Figura \ref{fig:HojaTemplatePonchoCiaa} que incluye una hoja jerárquica con los pines disponibles en los conectores P1 y P2 y luego se agregaron etiquetas jerárquicas por cada pin utilizado en este desarrollo.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\linewidth]{Figuras/datalogger/Hardware/HojaTemplatePonchoCiaa.png}
    \caption{Template disponible para la realización de ponchos para la EDU-CIAA.}
    \label{fig:HojaTemplatePonchoCiaa}
\end{figure}


Por cada módulo, se agregó una hoja jerárquica que contiene el circuito esquemático como se indica en la Figura \ref{fig:esquematicoPonchoDatalogger}. En total, se dividió en seis hojas jerárquicas: una para el módulo RS485, otra para el módulo Ethernet W5100, otra para el circuito PWM, otra para la fuente de alimentación (\textit{power supply}), otra para los LEDs y una más para el circuito que mide la tensión en el variador del túnel. Además, se diseñaron los símbolos para los módulos W5100, RS485-TTL y el convertidor DC-DC usando el editor de símbolos de KiCad, ya que estos no vienen precargados en el software. También se diseñaron sus respectivos footprints con el editor de huellas, tomando las dimensiones y la distribución de pines de cada módulo para que se puedan agregar correctamente al PCB.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{Figuras/datalogger/Hardware/esquematicoPonchoDatalogger.png}
    \caption{Diseño del esquemático que integra los módulos desarrollados.}
    \label{fig:esquematicoPonchoDatalogger}
\end{figure}



% mostrar el diseño del poncho esquematico, PCB y la placa armada (fabricacion SMN o LCI)

En la Figura \ref{fig:pcbDesing} se muestra el diseño del PCB de doble capa, con la capa inferior (\textit{Bottom}) en azul y la capa superior (\textit{Top}) en rojo. Las dimensiones de los bordes recortados y la tira de 20 pines en la parte superior e inferior forman parte del template; el resto del circuito se diseñó en función de las necesidades de cada módulo. Las pistas tienen un ancho de entre 30 y 40 mils. Se agregaron vías de \SI{2}{\milli\meter} de diámetro con un agujero de \SI{1}{\milli\meter} para conectar la capa superior con la capa inferior. Además, los pads tienen un tamaño de \SI{2}{\milli\meter}.


% Se armó el circuito con componentes SMD para la capa bottom y otro componetes thoguhole para la capa TOP, se hizo de esta forma poque 


En la figura \ref{fig:pcb3dBottom} se muestra la vista 3D de capa \textit{Bottom} donde se diseñó los circuitos PWM, el adquisidor de tensión de la fuente y el adquisidor de tensión del variador, utilizando componentes SMD. Se emplearon diodos, capacitores y resistores con tamaño de paquete 1206 y para los transistores NPN MMBT3904 y el operacional LM358 se cargaron sus footprints SMD de la biblioteca de KiCad. Por otro lado, en la capa \textit{Top} de la Figura \ref{fig:pcb3dTop} se han añadido los tres LEDs con montaje THT y se han dispuesto dos tiras de pines 3x1 para la conexión física de los dos potenciómetros (\textit{presets}). Además, debido a la falta de disponibilidad del diodo Zener SMD de \SI{3.3}{\volt} para proteger el ADC-CH1 de la placa EDU-CIAA, se adquirió el mismo componente pero con montaje THT. También se han incorporado los footprints de los módulos previamente diseñados: el módulo Ethernet, el módulo RS485-UART que incluye su propia bornera para la conexión del anemómetro bajo calibración y el módulo DC-DC \textit{step-down}. Además, se agregó una bornera de 2x1 para alimentar el \textit{datalogger} con \SI{12}{\volt}, y otra bornera 3x1 para la conexión con el variador del túnel de viento.
\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/pcbDesing.png}
    \caption{Diseño PCB del \textit{shield} que contiene todos los módulos descritos en las secciones anteriores.}
    \label{fig:pcbDesing}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\linewidth]{Figuras/datalogger/Hardware/pcb3dBottom.png}
    \caption{Vista en 3D de la capa BOTTOM.}
    \label{fig:pcb3dBottom}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\linewidth]{Figuras/datalogger/Hardware/pcb3dTop.png}
    \caption{Vista en 3D de la capa TOP.}
    \label{fig:pcb3dTop}
\end{figure}

Para la construcción del \textit{shield}, se seleccionó una placa simple faz por su disponibilidad en el SMN. Debido a restricciones de tiempo, se optó por ensamblar la placa en el laboratorio del SMN, siguiendo estos pasos: Inicialmente, se empleó una insoladora de tubos UV y papel fotosensible para transferir el diseño a la placa. Los negativos del diseño se imprimieron en papel transparente. Después, se utilizó ácido perclórico para retirar el cobre remanente. Finalizado este procedimiento, se cortó la placa a la medida deseada y se perforaron los \textit{pads} con una herramienta \textit{Dremel}. Se aplicó una capa de máscara antisoldante para facilitar la soldadura de los componentes y proteger la placa. Dado que la placa era de tipo simple faz, se añadieron manualmente las pistas de la capa superior (\textit{Top}) usando pequeños cables. El proceso concluyó con la soldadura de todos los módulos y componentes. En la Figura \ref{fig:poncho3Final} se ilustra el resultado final del montaje. Se conecta un cable USB al puerto \texttt{USB-DEBUG} para programar y depurar la placa. El sensor de viento patrón se conectará a la bornera azul del puerto \texttt{RS485 EDU-CIAA}, mientras que el anemómetro bajo calibración se conectará a la bornera verde del módulo \texttt{RS485 MAX485}. En la parte superior de la figura, se observa una bornera azul para conectar los tres cables provenientes del variador de velocidad del túnel: \texttt{VCC}, \texttt{VADC} y \texttt{GND}. En el lado izquierdo, se ha conectado un cable UTP a la red local del SMN a través de \texttt{Ethernet}, y en la bornera verde situada en la parte inferior izquierda, se ha conectado la alimentación de entrada de $V_{in} = \SI{12}{\volt}$. Para alimentar la placa sin USB, se dejan dos pines \texttt{Vcc\_5V} y \texttt{GND} que tienen \SI{5}{\volt} provenientes del módulo \texttt{DC-DC} y se conectan a la \texttt{fuente externa de 5V} con dos cables. Adicionalmente, se encuentran disponibles los dos \textit{presets} para recalibrar tanto el amplificador operacional como el circuito encargado del muestreo de esta señal. Finalmente, se observan los indicadores LED: el LED verde parpadea al recibir datos por el puerto RS485 de la EDU-CIAA, el LED amarillo parpadea al recibir datos por el puerto RS485 del módulo, y el LED blanco cambia a verde cuando la placa está conectada al servidor, o a rojo si no lo está.



% \begin{figure}[H]
%     \centering
%     \includegraphics[width=0.6\linewidth]{Figuras/datalogger/Hardware/poncho1.jpg}
%     \caption{Shield conectado a la placa EDU-CIAA}
%     \label{fig:poncho1}
% \end{figure}


% \begin{figure}[H]
%     \centering
%     \includegraphics[width=0.5\linewidth]{Figuras/datalogger/Hardware/poncho2.jpg}
%     \caption{Otra vista del Shield diseñado para esta aplicación.}
%     \label{fig:poncho2}
% \end{figure}



\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{Figuras/datalogger/Hardware/poncho3Final.png}
    \caption{Vista superior de la placa \textit{shield} conectada a la EDU-CIAA}
    \label{fig:poncho3Final}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%-----------------------------------------------------------------------------------------------------
\section{Desarrollo del firmware}\label{sec:desarrolloFirmware}

El proyecto CIAA brinda un \textit{framework} para programar las placas de desarrollo. La última versión, el \texttt{firmware\_v3} \cite{ciaa2024}, es un proyecto basado en makefile para desarrollar firmware en C/C++. En particular se utilizó la biblioteca sAPI, que ofrece ejemplos para programar los periféricos del microcontrolador. Además, el proyecto incluye un lanzador de aplicaciones Figura \ref{fig:ciaaLauncher}, que trae integrado el IDE GNU MCU Eclipse como entorno de programación, OpenOCD para programación y depuración, drivers para conectar la EDU-CIAA a la PC, entre otras herramientas. 

\begin{figure}[H]
    \centering
    \includegraphics[width=0.3\linewidth]{Figuras/datalogger/Firmware/ciaaLauncher.png}
    \caption{Lanzador de aplicaciones integradas para el desarrollo de firmware para la EDU-CIAA.}
    \label{fig:ciaaLauncher}
\end{figure}

Se clonó el repositorio que contiene el \texttt{firmware\_v3} de GitHub en el IDE y se abrió un nuevo proyecto llamado \texttt{Datalogger}, como se indica en la Figura \ref{fig:projectDataloggerFolder}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.40\linewidth]{Figuras/datalogger/Firmware/projectDataloggerFolder.jpg}
    \caption{Estructura de carpetas, del proyecto Datalogger}
    \label{fig:projectDataloggerFolder}
\end{figure}
En particular, la lógica del programa se implementó mediante el uso de máquinas de estado (\textit{statecharts}) de Harel, empleando el software Itemis Yakindu \cite{itemis_create}. Los \textit{statecharts} de Harel amplían los diagramas de estados tradicionales incorporando conceptos de modularidad, jerarquía y estructura organizacional, similar a las maquinas de estado UML \cite{uml_state_machine}. Estos diagramas se caracterizan por el uso de estados compuestos y subdiagramas que preservan la claridad y la organización, y facilitan la ejecución concurrente de múltiples submáquinas de estado a través de regiones ortogonales. Además, los eventos que inician con (\textit{e\_}) habilitan la comunicación por difusión, mientras que las transiciones condicionales que se denotan entre llaves ([\textit{condición de guarda}]), los estados históricos, la lógica temporal y las acciones de entrada/salida potencian la funcionalidad de los \textit{statecharts}, optimizando la modelización de sistemas complejos de manera eficiente. La Tabla~\ref{tab:compStateCharts} presenta un análisis comparativo entre las máquinas de estado simples, como las de Mealy y Moore, y las máquinas de estado más avanzadas de UML y Harel.


\begin{table}[H]
\fontsize{10}{8}\selectfont
\begin{tblr}{
  colspec = {Q[l,8cm] Q[c,1.5cm] Q[c,1.5cm] Q[c,1.5cm] Q[c,1.5cm]},
  rows = {m},
  row{1} = {font=\bfseries},    
  % cells = {c},
  row{1} = {Sail,font=\bfseries},
  hlines,
  vlines,
}
    Descripción & Mealy     & Moore    & Harel    & UML \\
    Estados y transiciones & \checkmark & \checkmark    & \checkmark    & \checkmark \\
    Las transiciones producen salida & \checkmark   & $\chi$    & \checkmark    & \checkmark \\
    Los estados producen salida & $\chi$    & \checkmark    & \checkmark    & \checkmark \\
    Profundidad (jerarquías, estados compuestos) & $\chi$   & $\chi$ & \checkmark   & \checkmark \\
    Ortogonalidad (submáquinas de estado paralelas) & $\chi$    & $\chi$    & \checkmark    & \checkmark\\
    Comunicación por difusión (eventos) & $\chi$    & $\chi$    & \checkmark    & \checkmark\\
    Historial, acciones, retrasos, tiempos de espera, condicione de guarda & $\chi$    & $\chi$    & \checkmark    & \checkmark\\
\end{tblr}
\caption{Diferencias entre los tipos de máquinas de estados.}
\label{tab:compStateCharts}
\end{table}


Se crearon doce regiones donde cada una contiene una maquina de estados. A partir de una maquina principal (\textit{main}) el resto de estas trabajan de forma concurrente (de forma ortogonal). En la Figura \ref{fig:ordenRegiones} se muestran las regiones que se comunican entre sí mediante eventos y señales internas. A cada región se le asigna una prioridad en función de su posición; las que están más arriba tienen mayor prioridad de ejecución respecto a las de más abajo.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Figuras/datalogger/Firmware/ordenRegiones.jpg}
    \caption{Lista de regiones con su respectiva prioridad.}
    \label{fig:ordenRegiones}
\end{figure}

Se utilizó una licencia educativa, gratuita de Yakindu, integrándola en el IDE de Eclipse para editar y generar el código a partir de los \textit{statecharts}. En particular, se configuró el proyecto en Yakindu C/C++ para poder agregar código en C a las máquinas de estado, incluyendo la importación de archivos \texttt{.h}, declaración de variables, punteros globales y constantes. Para más detalle del código se puede acceder al repositorio del proyecto \cite{FirmwareSCA2024}.

La máquina de estado principal se muestra en la Figura \ref{fig:sc_main}, e inicializa y configura la placa, el SPI, las UARTs, un contador de \textit{ticks} (tiempos de reloj) y el resto de las máquinas de estado. Luego, pasa a un estado inactivo, esperando alguna interrupción. Cuando ocurre una interrupción, se verifica el estado de un \textit{flag} del temporizador principal del sistema. Si el \textit{flag} está activo, se actualizan todos los \textit{ticks} de los temporizadores. Posteriormente, el sistema escanea todos los \textit{ticks} de los temporizadores para verificar eventos pendientes. Si hay eventos pendientes, estos se levantan en su respectiva máquina de estados. Finalmente, la máquina de estados ejecuta un ciclo para manejar los eventos levantados (\textit{raiseEvent}). Luego, el sistema regresa al estado inactivo, esperando la próxima interrupción.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.65\linewidth]{Figuras/datalogger/Firmware/sc_main.png}
    \caption{Maquina de estados principal, que gestiona la ejecución del resto de las maquinas de estado.}
    \label{fig:sc_main}
\end{figure}

% como se ejemplifica en el Código \ref{cdg:configuracionStateChart}.

% Para reducir el tamaño de letra del código
% basicstyle=\ttfamily\fontsize{8}{8}\selectfont

% \begin{lstlisting}[style=yakindustyle, caption={Configuración principal del modelo statechart dataloggerSA.}, label=cdg:configuracionStateChart,basicstyle=\ttfamily\fontsize{8}{8}\selectfont] 
% import:"inc/common.h"
% import:"inc/da_acquisition.h"
% import:"inc/da_processing.h"
% import:"inc/da_transmision.h"
% import:"inc/da_rtc.h"
% import:"inc/da_configDatalogger.h"
% import:"inc/controlTunnel.h"
% /*Datalogger para Sistema anemometrico con EDU-CIAA-NXP */
% interface:
% //Variables
% var startMesuare:uint8_t = FALSE
% //Puntero
% var ptrStartMesuare:ptrUnt8_t
% var viTeclaOprim: uint16_t
% //Constantes
% const TRUE: uint8_t =1
% const FALSE: uint8_t =0
% const Tec1: uint16_t = 1<<0
% const Tec2: uint16_t = 1<<1
% \end{lstlisting}

%  También se agregaron eventos internos que permiten transicionar del estado de una región a otro estado de otra región (\textit{raiseEvent} en inglés), como se muestra en el Código \ref{cdg:eventosInternos}.
% \begin{lstlisting}[style=yakindustyle, caption={Declaración de eventos internos que permiten transicionar entre regiones del statechart.}, label=cdg:eventosInternos,basicstyle=\ttfamily\fontsize{8}{8}\selectfont]
% internal:
% //En forma interna tengo seniales para vincular las maquinas de estado
% event siDatosListosParaBdtos
% event siDatoProcesado
% event siMuestrasNuevas
% event siStartMeasure
% event siKeepAlive
% event siProccesMsjServer
% \end{lstlisting}

% En cada subseccion agregar su region de yakindu

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Configuración y conexión con los servidores}\label{sec:confServers}
Como se detalló en la sección \ref{sec:moduloEthernet}, se utilizó el módulo W5100 para transferir datos desde el \textit{datalogger} hacia los servidores y recibir datos de los mismos. El módulo cuenta con cuatro \textit{sockets} independientes que permiten configurar un sistema embebido como servidor o cliente.
como se muestra en la Figura \ref{fig:socketModoDeTrabajoW5100}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\linewidth]{Figuras/datalogger/Firmware/socketModoDeTrabajoW5100.png}
    \caption{Modos de configuración para el módulo W5100 \cite{W5100Datasheet}.}
    \label{fig:socketModoDeTrabajoW5100}
\end{figure}

El \textit{datalogger} se comunica con los servidores en modo cliente, enviando una solicitud de conexión a un servidor, estableciendo la comunicación e intercambiando datos. Luego, realiza una solicitud de desconexión y se cierra el enlace. Utiliza, en la capa de transporte, el protocolo TCP y en la capa de red, el protocolo IP. En la capa de aplicación, se utilizó el protocolo \textit{WebSocket} para intercambio de datos y el protocolo NTP para configurar el RTC del \textit{datalogger}. Dado que estos protocolos no están incluidos en la biblioteca del chip W5100, se implementó la conexión, el intercambio de datos y la desconexión de los servidores mediante las funciones de \textit{sockets} que trae la biblioteca \cite{wiznet2024}.
% , como se indica en el diagrama de flujo de la figura \ref{fig:socketDiagramClientW5100}.

% Un socket es una interfaz que permite la comunicación entre dispositivos a través de redes. En términos simples, un socket es un punto final para enviar y recibir datos en una red, y está compuesto por una dirección IP y un número de puerto.
% \begin{figure}[H]
%     \centering
%     \includegraphics[width=0.9\linewidth]{Figuras/datalogger/Firmware/socketDiagramClientW5100.png}
%     \caption{Diagrama de flujo para establer una comunicación, en modo cliente, con un servidor utilizando sockets.}
%     \label{fig:socketDiagramClientW5100}
% \end{figure}

\subsubsection{Servidor NTP}\label{sec:serverNTP}
% poner diagrama de Config RTC, para que esta
Para la configuración del RTC del \textit{datalogger}, se estableció una conexión con los servidores NTP del Instituto Nacional de Estándares y Tecnología (NIST, por sus siglas en ingles). Se seleccionó una de las múltiples IPs disponibles, específicamente la dirección 128.138.141.172 a través del puerto 13. El servidor retorna una cadena de caracteres, \texttt{59992 23-02-17 17:47:01 00 0 0 831.5 UTC(NIST)*}, que se procesa y se guarda en una estructura que contiene las variables de hora y fecha del RTC. Para gestionar y validar esta comunicación con el servidor NTP, se configuró una máquina de estados específica dentro del sistema, ilustrada en la Figura \ref{fig:sc_configRTC}.


% \\textsc{begin{lstlisting}[style=yakindustyle, caption={Declaración de variables booleanas para validar la conexion con el servidor NTP.}, label=cdg:serRTC,basicstyle=\ttfamily\fontsize{8}{8}\selectfont]
% // Variables para la conexion al servidor NTP
% var ConfigNtpSocket: uint8_t=FALSE
% var setRtc: uint8_t = FALSE
% var ConfigNTP:uint8_t = FALSE
% \end{lstlisting}}


La máquina comienza en el estado \textbf{Inicio} y luego de un tiempo predefinido, transiciona al estado \textbf{Configurar socket}, el cual se encarga de configurar los parámetros de red del cliente: gateway, dirección MAC, máscara de subred e IP locales. Posteriormente, estos parámetros se cargan en uno de los cuatro \textit{sockets} del módulo W5100, se configura el protocolo de transporte (TCP en este caso), se asigna un puerto y se abre la conexión para establecer comunicación con el servidor. Si la apertura y configuración son correctas, la máquina de estados transiciona al estado \textbf{Configurar servidor NTP}, donde se configura la dirección IP y el puerto, y con estos datos se solicita una conexión al servidor NTP. En caso de que la conexión esté lista, el servidor devuelve la fecha y la hora actual en formato UTC. La máquina de estados transiciona al estado \textbf{Establecer fecha y hora}, donde se procesa la información recibida y se actualiza el RTC (reloj de tiempo real) del \textit{datalogger}. Finalmente, se cierra la conexión con el servidor NTP, pasando al estado \textbf{Inactividad}. Cuando se realiza esta última transición, se eleva un evento a través de la señal \texttt{s\_Iniciar configuración}, la cual será un disparador para transicionar entre estados de otra máquina de estados que gestiona la conexión con el servidor \textit{WebSocket}. En caso de fallo en cualquiera de los estados previos, se transiciona al estado \textbf{Establecer Fecha y hora por defecto}, donde se establece por valores predeterminados.

% La máquina comienza en el estado \textbf{INIT} y luego de un período de \texttt{DelatInit} segundos, pasa al estado \textbf{CONFIG\_SOCKET}. En este estado, se llama a la función \texttt{opConfigNtpSocketViaTCP()}, que se encarga de configurar los parámetros de red del cliente: gateway, dirección MAC, máscara de subred e IP. 

% Luego, estos parámetros se asignan a uno de los cuatro sockets del módulo W5100, y se configura el protocolo de transporte (TCP en este caso), el puerto, y se abre la conexión para establecer una comunicación con el servidor. Esta función devuelve \texttt{True} si la apertura y configuración son correctas, almacenando este resultado en la variable \texttt{ConfigNtpSocket}. Si la configuración es exitosa, la máquina de estados transiciona al estado \textbf{CONFIG\_NTP}.

% En el estado \textbf{CONFIG\_NTP}, se invoca la función \texttt{opConfigNtpViaTCP()}, encargada de configurar la conexión con el servidor NTP. Esta función establece la dirección IP y el puerto del servidor y realiza un intento de conexión. Si la conexión es exitosa, la función retorna \texttt{True} y el resultado se almacena en la variable \texttt{ConfigNTP}. Una vez configurado, el servidor responde con la hora y fecha actual en formato UTC, que se guarda en una variable interna. Posteriormente, la máquina de estados avanza al estado \textbf{SET\_RTC\_VIA\_SOCKET}, donde se procesa la información recibida y se actualiza el RTC del datalogger. Finalmente, se cierra la conexión con el servidor NTP pasando al estado \textbf{IDLE}, cuando se realiza esta última transición se eleva un evento a través de la señal \texttt{siStartMeasure}, la cual será un disparador para iniciar otra máquina de estado en otra región. En caso de fallo en cualquiera de los estados previos, se transiciona al estado \textbf{SET\_RTC\_DEFAULT}, donde se establece una hora predeterminada.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{Figuras/datalogger/Firmware/sc_configRTC.png}
    \caption{Máquina de estados para configurar el RTC del datalogger a través de un servidor NTP.}
    \label{fig:sc_configRTC}
\end{figure}

\subsubsection{Servidor WebSocket}\label{sec:serverWebSocket}
 
El protocolo \textit{WebSocket} es una tecnología de comunicación que permite intercambio de información bidireccional (\textit{full-duplex}) entre un cliente y un servidor a través de un solo canal de conexión TCP. Es especialmente útil para aplicaciones Web que requieren comunicación en tiempo real, como juegos en línea, chat en vivo y servicios de trading. Para establecer una conexión \textit{WebSocket}, el cliente envía una solicitud de  \textit{handshake} (aprenton de manos) al servidor. Esta solicitud sigue el protocolo HTTP con un \textit{upgrade} para solicitar el cambio de protocolo a \textit{WebSocket}. Aquí se muestra un ejemplo de cómo se ve una solicitud de \textit{handshake} de \textit{WebSocket}:

\begin{verbatim}
GET /mychat HTTP/1.1
Host: 10.10.13.153
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==
Sec-WebSocket-Protocol: chat, superchat
Sec-WebSocket-Version: 13
Origin: http://example.com
\end{verbatim}

El servidor, al recibir esta solicitud, si acepta la conexión responde con una respuesta de \textit{handshake} :

\begin{verbatim}
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=
Sec-WebSocket-Protocol: chat
\end{verbatim}

La clave \texttt{Sec-WebSocket-Accept} es generada por el servidor a partir de la clave \texttt{Sec-WebSocket-Key} enviada por el cliente, lo que confirma que el servidor entiende y acepta la solicitud de \textit{WebSocket}. Una vez establecido el \textit{handshake}, el cliente y el servidor pueden enviar datos en forma de \textit{frames} de \textit{WebSocket}, que pueden ser datos de texto o binarios. 

La máquina de estados que gestiona la conexión con el servidor \textit{WebSocket} se muestra en la Figura \ref{fig:sc_connectionWebSocket}. Comienza en el estado \textbf{Inicio}, la transición al estado \textbf{Configurar socket} se desencadena por el evento de la señal \texttt{s\_Iniciar configuración}, generado por la máquina de estados que configura el RTC. Esto asegura que no se inicie la configuración del servidor \textit{WebSocket} hasta que la hora esté correctamente sincronizada. En el estado \textbf{Configurar socket}, nuevamente se configura  los parámetros de red del módulo W5100 y también se establece el protocolo TCP, asignando un número de puerto al cliente. Tras abrir el \textit{socket} con exito, la máquina de estados avanza al estado \textbf{Iniciar Cliente} donde se prepara los datos necesarios para la conexión con el servidor \textit{WebSocket}, que son: la dirección IP del servidor, el puerto y el mensaje de \textit{handshake}. Luego de preparar el cliente, se transiciona al estado \textbf{Conectar al servidor}. Aquí se gestiona el envío de la solicitud de \textit{handshake} al servidor y se procesa su respuesta. Si la conexión es exitosa, se establece un \textit{flag} en true, lo que servira como condicion de guarda para la transicion de otras maquinas de estado concurrentes. Finalmente la conexión está lista para el intercambio de datos en modo full-duplex. Si se presenta una falla en cualquiera de los estados previos, la máquina de estados regresa al estado \textbf{Configurar socket} para intentar una nueva conexión con el servidor.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{Figuras/datalogger/Firmware/sc_connectionWebSocket.png}
    \caption{Máquina de estados para establecer una conexión bidireccional con un servidor \textit{WebSocket}.}
    \label{fig:sc_connectionWebSocket}
\end{figure}
% Luego hablar del keep alive 

Para prevenir la desconexión automática con el servidor en ausencia de intercambio de datos, se implementó una máquina de estados de la Figura \ref{fig:sc_keepAlive}, que tiene un doble propósito: primero, mantener activa la comunicación con el servidor incluso cuando no hay tráfico de datos; y segundo, realizar una consulta periódica (\textit{polling}) con un retardo no bloqueante para verificar si se ha recibido algún mensaje del servidor. El estado final \textbf{Conectar al servidor} de la máquina de estados de la Figura \ref{fig:sc_connectionWebSocket}, al completar su secuencia de operaciones, genera un evento con la señal \texttt{s\_KeepAlive}. Esta señal, en conjunción con la condición de que la conexión con el servidor esta establecida permite la transición desde el estado \textbf{Inactividad} hacia el estado \textbf{Tx KeepAlive y Rx mensajes}. En este último estado, se transmiten los mensajes de \textit{keepAlive} hacia el servidor para mantener la conexion con el mismo cada \SI{500}{\milli\second} y además se escanea si el servidor ha enviado un mensaje al \textit{datalooger}. Por otro lado, se activa un evento a través de la señal \texttt{s\_ProccesMsjServer} que permitirá transicionar de estados a la siguiente máquina de estados.


% En este estado se invoca a la función \texttt{KeepAlive(ptrSizeBuff)} que se encarga de enviar un mensaje vacío al servidor para mantener la comunicación y revisar si hay algún mensaje del servidor guardándolo en un buffer. En caso de 


\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{Figuras/datalogger/Firmware/sc_keepAlive.png}
    \caption{Máquina de estados para mantener la conexión con el servidor y elevar un \textit{raiseEvent} en caso de que se reciba información del servidor.}
    \label{fig:sc_keepAlive}
\end{figure}

% % La recepcion de comandos para configurar
% Puesto que se puede recibir datos del servidor, se declaran las siguientes variables del Código \ref{cdg:SetCommanBuffer}

% \begin{lstlisting}[style=yakindustyle, caption={Declaración de variables para validar y procesar la recepción de datos del servidor.}, label=cdg:SetCommanBuffer,basicstyle=\ttfamily\fontsize{8}{8}\selectfont]
% //Procesamiento de comandos
% //Size de comandos
% var sizeBuff: uint16_t =0
% var ptrSizeBuff: ptrUnt16_t
% //Estructura de configuracion a traves de comandos
% var configCommand:config_t
% var ptrConfigCommand:ptrConfig_t=configCommand.pointer
% \end{lstlisting}

La máquina de estados de la Figura \ref{fig:sc_processComand} se encarga de procesar los datos recibidos por el servidor \textit{WebSocket}. Se inicia en el estado de \textbf{Inactividad} y cuando se activa la señal \texttt{s\_ProccesMsjServer} y el tamaño de los datos recibidos es mayor a cero, se transiciona al estado \textbf{Procesar mensaje}, donde se procesan los mensajes provenientes del servidor. Estos mensajes pueden incluir comandos de configuración para el \textit{datalogger} o valores de referencia para el control del túnel, detallados la tabla \ref{tab:comandoDataloggerWeb}.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Figuras/datalogger/Firmware/sc_processComand.png}
    \caption{Máquina de estados para procesar los mensajes recibidos del servidor \textit{WebSocket}.}
    \label{fig:sc_processComand}
\end{figure}

Para gestionar eficientemente los comandos destinados a configurar diversas partes del \textit{datalogger} con la información proporcionada por el software, se establece un diccionario de punteros a función detallado en el repositorio del proyecto \cite{FirmwareSCA2024}.

% Este diccionario, ilustrado en el código~\ref{cdg:diccCommand}, permite ejecutar una función específica en respuesta a cada comando o petición contenida en el mensaje recibido.

% \begin{lstlisting}[style=cstyle, caption={Funciones que permiten configurar o modificar el comportamiento del dataloger.}, label=cdg:diccCommand,basicstyle=\ttfamily\fontsize{8}{8}\selectfont]
% char *diccCommands[]={
% 				"start",
% 				"stop",
% 				"setIBC",
% 				"setPAT",
% 				"setTimes",
% 				"refWindVel",
% 				"NAN"};
% bool_t (*diccProcesos[])(config_t * commandConfig)={
% 							start,
% 							stop,
% 							setIBC,
% 							setPAT,
% 							setTimes,
% 							refWindVel};

% \end{lstlisting}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Muestreo, adquisición y procesamiento}\label{sec:muestreo_adquisicion_procesamiento}

% Para almacenar las muestras de los sensores de viento, patrón y bajo calibración, así como los niveles de tensión de la fuente y la tensión que ingresa al variador de velocidad, se han declarado las variables y constantes que van a interactuar con las maquinas de estado.
Los sensores de viento estan configurados en modo ráfaga y envían los datos con una cadencia de un segundo. Para configurar cada anemómetro, se requiere la información especificada en la tabla \ref{tab:sensorDataStruct}. Los primeros cuatro datos son ingresados por el operador a través de la aplicación Web descrita en el capítulo \ref{cap:aplicacionweb}. A continuación, se dispone de dos buffers: el primero, de 100 caracteres, se utiliza para almacenar temporalmente cada mensaje recibido por el sensor. Posteriormente, los datos procesados se almacenan en el segundo buffer y quedan listos para ser enviados al servidor \textit{WebSocket}.

\begin{table}[H]
    \centering
    \fontsize{10}{8}\selectfont
    \begin{tblr}{
      cells = {c},
      row{1} = {Sail},
      hlines,
      vlines,
    }
    Variable & Memoria [bits] & Descripcion                              \\
    UART     & 16             & Número de Uart.                          \\
    LED      & 16             & Número de LED de la placa.               \\
    BAUDRATE & 32             & Velocidad de comunicación RS485.         \\
    SENSOR   & 15x8           & Modelo de sensor.\\              
    BUFFER1  & 100x8          & Buffer para almacenar el string del sensor. \\
    BUFFER2    & 7x32           & Buffer para almacenar el dato procesado. \\
    
    \end{tblr}
    \caption{Conjunto de variables asociadas a un sensor de viento.}
    \label{tab:sensorDataStruct}
\end{table}


En la Figura \ref{fig:sc_sampleSensorWind}, se muestra la máquina de estados encargada de adquirir los datos de los sensores de viento. La máquina de estados comienza en el estado \textbf{Inactividad}. Luego, cuando se recibe el comando de iniciar mediciones desde el servidor, se transiciona al estado \textbf{Activar interrupción Uart\_n}. En este estado, primero se configuran los datos según la tabla \ref{tab:sensorDataStruct} y luego se activa la interrupción de la correspondiente UART, quedando el \textit{datalogger} listo para recibir datos de los sensores de viento. Cada vez que se activa la interrupción, se ejecuta un \textit{callback} que llama a una función encargada de procesar y separar los datos recibidos. Si se recibe del servidor el comando de detener mediciones, la máquina de estados transiciona al estado \textbf{Desactivar interrupción Uart\_n}, donde se desactiva la interrupción y el microcontrolador deja de tomar muestras de los anemómetros.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\linewidth]{Figuras/datalogger/Firmware/sc_sampleSensorWind.png}
    \caption{Máquina de estados para tomar muestras de los sensores viento.}
    \label{fig:sc_sampleSensorWind}
\end{figure}

El string del patrón VAISALA, modelo WMT700 tiene el formato \texttt{\$--MWV,021,R,003.34,N,A*14}, mientras que el del instrumento bajo calibración DELTAOHM, modelo HD51.3 tiene el formato \texttt{28.30 359.3 998.3<CR><LF>}. Para procesar y separar estos datos, se utiliza un diccionario de punteros a funciones. Desde el software, el operador preconfigura el modelo del anemómetro y esto hace que en la  máquina de estados se llame a la función correspondiente para procesar los datos de cada anemómetro.

En la Figura \ref{fig:sc_sampleSensorVoltage} se muestra la máquina de estado que se utiliza para adquirir los niveles de tensión de la fuente de alimentación o los niveles de tensión del variador de velocidad. La máquina de estado comienza en el estado \textbf{Inicio} y automáticamente transiciona al estado \textbf{Inactividad}. Luego cuando se recibe el comando iniciar mediciones y se produce la transición al estado \textbf{Tomar Muestra}, donde se adquiere una muestra del nivel de tensión a traves de los circuitos diseñados en la seccion \ref{sec:desarrolloHardware}. Después de transcurrido el tiempo $t_{1}$ definido como el tiempo de muestreo, se pasa al estado \textbf{Guardar muestra}, donde se guarda la muestra  y se activa una señal \texttt{s\_Acumular muestra} que permite activar una transición de la siguiente máquina de estado. Finalmente, se regresa al estado \textbf{Inactividad} para repetir el ciclo indefinidamente o hasta que se envie el comando de detener mediciones.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\linewidth]{Figuras/datalogger/Firmware/sc_sampleSensorVoltage.png}
    \caption{Máquina de estado para tomar muestras de la tensión del alimentación y del variador.}
    \label{fig:sc_sampleSensorVoltage}
\end{figure}

La máquina de estado de la Figura \ref{fig:sc_processing} se utiliza para procesar las muestras acumuladas. Inicia en un estado de \textbf{Inactividad} y la transición al estado \textbf{Acumular muestras} se produce cuando se ha activado la señal \texttt{s\_Acumular muestra}  y al mismo tiempo se cumplen dos condiciones: primero, que el número de muestras sea menor al cociente entre el intervalo de tabla $t_{2}$ y el intervalo de muestra $t_{1}$; segundo, que el comando de iniciar mediciones esté activo. En este estado, se acumulan las muestras de todos los sensores, se incrementa el número de muestras en una unidad y luego se regresa al estado de \textbf{Inactividad}. Este ciclo se repite hasta que el número de muestras es igual al cociente entre el intervalo de tabla $t_{2}$ y el intervalo de muestra $t_{1}$, cuando se alcanza esta igualdad se pasa al estado \textbf{Procesar muestras}. Por ejemplo, si el operador define un intervalo de muestras $t_{1} = \SI{1}{\second}$ y un intervalo de tabla $t_{2} = \SI{10}{\second}$, el cociente da $\frac{t_{2}}{t_{1}}=10$ muestras. Los datos se acumulan hasta que el número de muestras llega a 10 y con esa condición se produce la transición al estado \textbf{Procesar muestras}. En este estado, se calcula el promedio, el valor mínimo y el valor máximo de las 10 muestras. Luego, se reinicia el número de muestras a cero y se activa la señal \texttt{s\_tx\_WebSocketServer}, que será utilizada para transmitir datos al servidor en la siguiente máquina de estados. Finalmente, se vuelve al estado \textbf{Inactividad} para acumular las próximas mediciones.


\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\linewidth]{Figuras/datalogger/Firmware/sc_processing.png}
    \caption{Máquina de estados para acumular muestras en una tabla y realizar un preprocesamiento de esos datos.}
    \label{fig:sc_processing}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Transmisión al servidor}

El protocolo \textit{WebSocket} establece una comunicación en tiempo real entre clientes y servidores, adaptando el encabezado del mensaje según su tamaño. Para mensajes hasta 125 bytes, se usa un encabezado de 2 bytes. Para mensajes mayores, se añade un encabezado extendido con 2 bytes adicionales para la longitud. Independientemente del tamaño, todos los mensajes se enmascaran con una clave de 32 bits aplicada mediante XOR a la carga útil, protegiendo la transmisión contra vulnerabilidades y garantizando la integridad de los datos. Este mecanismo asegura que todos los mensajes, independientemente de su tamaño, se transmitan de manera confiable y conforme a las normas del protocolo \cite{websockeWiki}. 

% Para una transmisión exitosa desde el datalogger hacia el servidor, se declara la variable de Código \ref{cdg:transmitionServer}, esta variable controla el estado de la transmisión en la máquina de estados de la región \texttt{TransmisionAlServer} de la figura \ref{fig:transmisionServer}.

% \begin{lstlisting}[style=yakindustyle, caption={Declaración de variable para controlar el estado de una transmisión al servidor.}, label=cdg:transmitionServer,basicstyle=\ttfamily\fontsize{8}{8}\selectfont]
% //Transmision por Ethernet
% var TransmisionExitosa: uint8_t=FALSE
% \end{lstlisting}

La máquina de estados de la Figura \ref{fig:sc_transmisionServer} inicia en el estado \textbf{Inactividad}. Cuando se detecta la señal \texttt{s\_tx\_WebSocketServer} y el comando de iniciar mediciones esté activo, se realiza una transición al estado \textbf{Transmisión de mensaje}. En este estado se codifica y envia el mensaje a través del \textit{socket} del módulo Ethernet conectado al servidor Web. La codificación del mensaje depende de su longitud, para ello se implementaron dos métodos internos que se muestran en detalle en el repositorio \cite{FirmwareSCA2024}:
\begin{itemize}
  \item Si la longitud del mensaje es de hasta 125 bytes, se utiliza un método específico. El encabezado del mensaje codificado consta de 2 bytes.
  \item Si la longitud del mensaje supera los 125 bytes, se emplea otro método, que añade un campo adicional de 2 bytes para indicar la longitud extendida del mensaje.
\end{itemize}

Tras la codificación, se procede con el envío del mensaje. El servidor, al recibir el mensaje, responde con la longitud del mensaje recibido. Si la longitud coincide con la del mensaje enviado, se considera que la transmisión ha sido exitosa. De lo contrario, se asume que la transmisión ha fallado. En caso de falla en la transmisión, la máquina de estados transiciona al estado \textbf{BackUp Mensaje}. Este estado se encarga de almacenar temporalmente los datos hasta que se restablezca la comunicación con el servidor. Si la transmisión es exitosa, se incrementa un contador y se retorna al estado \textbf{Inactividad}, quedando listo para una nueva transmisión.


\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{Figuras/datalogger/Firmware/sc_transmisionServer.png}
    \caption{Máquina de estados para gestionar la transmisión de datos al servidor \textit{WebSocket}.}
    \label{fig:sc_transmisionServer}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Sistema de control PID}\label{sec:sistemaDeControlPid}

En la Sección \ref{sec:circuitoPWM}, se detalla el desarrollo del circuito \textbf{PWM}. Este circuito, al recibir un valor digital entre 0 y 255, produce una tensión de salida que oscila entre $\SI{53}{\milli\volt}$ y $\SI{3.5}{\volt}$. Esta tensión se utiliza para controlar, a través del variador, la velocidad del motor que trae el túnel de viento, permitiendo cambiar la velocidad del aire entre $\SI{1}{\meter\per\second}$ y $\SI{25}{\meter\per\second}$. El circuito PWM se utiliza para la implementación de un controlador \textbf{PID} de lazo cerrado. La referencia de la velocidad del viento, en metros por segundo, se obtiene del servidor. Paralelamente, se toma una muestra de la velocidad del viento a través de un sensor patrón, también en metros por segundo. La diferencia entre la referencia y la muestra se define como el error, sobre el cual se aplica el control PID. El controlador PID cuenta con los siguientes parámetros, la ganancia proporcional $k_{p}$, integral $k_{i}$ y derivativa $k_{d}$ y para el manejo del error $e_{j}$, el error anterior $e_{j-1}$, la suma acumulada del error $e_{int_{j}}$ y la derivada del error $e_{dev_{j}}$ y puesto que es un controlador en tiempo discreto se incluye el tiempo de muestreo $T_{s}$. Con estos parametros se aplica el algoritmo de control \textbf{PID} sobre el error calculado para regular la salida del circuito PWM y, consecuentemente, la velocidad del viento en el túnel. Este proceso se realiza en la máquina de estados de la Figura \ref{fig:sc_controlTunnel}, está comienza en el estado \textbf{Configurar PID}, donde se configura los parámetros del controlador PID, obtenidos heurísticamente, con $k_{p} = 3$; $k_{d} = 0,5$; $k_{i} = 0.1$; y el tiempo de muestreo $T_{s} = \SI{1}{\second}$. Además, se configura el pin digital de la EDU-CIAA para habilitar la salida PWM con un valor inicial de cero. Cuando el comando iniciar mediciones está activo se transiciona al estado \textbf{Medición}, en este estado, se lee la intensidad instantánea del viento del anemómetro patrón y la intensidad de referencia enviada por el servidor, almacenando estos valores en variables. Posteriormente, se avanza al estado \textbf{Control motor túnel}. Aquí, se ejecuta las siguientes acciones:
\begin{itemize}
    \item Calcular el error proporcional $e_{j} = vel_{ref_{j}} - vel_{pat_{j}}$.
    \item Calcular el término integral $e_{int_{j}} = e_{j} \cdot T_{s}$.
    \item Calcular el término derivativo $e_{dev_{j}} = \frac{e_{j} - e_{j-1}}{T_{s}}$.
    \item Actualiza el error y calcula la acción de control como $u_{c_{j}} = k_{p} \cdot e_{j} + k_{i} \cdot e_{int_{j}} + k_{d} \cdot e_{dev_{j}}$.
\end{itemize}
El valor de $u_{c}$ se somete a un saturador entre 0 y 255, y luego se aplica esa tensión al pin de salida PWM. Este ciclo se repite cada $\SI{1}{\second}$, correspondiente al tiempo de muestreo $T_{s}$. Si se activa el comando que detiene las mediciones a través del software, se regresa al estado \textbf{Configurar PID} donde se reincia el controlador y permanece en espera hasta iniciar nuevas mediciones.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{Figuras/datalogger/Firmware/sc_controlTunnel.png}
    \caption{Máquina de estados que ejecuta el control PID con valores de referencia enviados por el servidor.}
    \label{fig:sc_controlTunnel}
\end{figure}
