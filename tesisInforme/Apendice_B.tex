\definecolor{Sail}{rgb}{0.643,0.819,0.976}
\section{Algoritmo del generador de trayectoria}
\begin{lstlisting}[style=pythonstyle, caption={Algoritmo generador de referencias para el controlador PID.}, label=cdg:genTrayectoria, basicstyle=\ttfamily\fontsize{8}{8}\selectfont]
def trajectoryGenerator(numCalib):
    # Por ahora asumimos que el sistema empieza con una velocidad inicial del viento de
    # 1 m/s que es lo que sucede generalmente al encender el tunel
    vel_init = 1
    vel_end = [1,1,1]
    calibracion_instance = get_object_or_404(Calibracion, numeroDeCalibracion=numCalib)
    datos_config_tunnel = ConfigTunel.objects.filter(calibracion=calibracion_instance)
    puntosCalibrar = list(datos_config_tunnel)[0].puntosCalibrar
    tipoDeMedicion = list(datos_config_tunnel)[0].tipoDeMedicion
    if tipoDeMedicion == "Solo Ascendente":
        velRef = puntosCalibrar.split(",")
    if tipoDeMedicion == "Solo Descendente":        
        velRef = puntosCalibrar.split(",")
        velRef = velRef[::-1]
    if tipoDeMedicion == "Asc - Des":        
        velRefA = puntosCalibrar.split(",")
        velRefB = velRefA[::-1]
        velRef = velRefA + velRefB
        pass
        
    velRef = [int(x) for x in velRef]
    aux = []
    for i in range(len(velRef)):
        aux.append( [velRef[i]] * 3) # se multiplica por 3 ya que quiero que llegue, estabilice y mida
    
    velRef = sum(aux, []) # convertimos a un vector la matriz auxiliar
    velRef = [vel_init] + velRef + vel_end
    # Tiempos en minutos, ingresados por el usuario, en principio es el mismo para todos los puntos
    tiempoTransitorio = list(datos_config_tunnel)[0].tiempoTransitorio*60
    tiempoEstabilidad = list(datos_config_tunnel)[0].tiempoEstabilidad*60
    tiempoMedicion = list(datos_config_tunnel)[0].tiempoMedicion*60
    cantidadPuntos = list(datos_config_tunnel)[0].cantidadPuntos
    if tipoDeMedicion == "Solo Ascendente" or tipoDeMedicion == "Solo Descendente" :
        t_des = [tiempoTransitorio,tiempoEstabilidad, tiempoMedicion] * (cantidadPuntos + 1)
    else:
        aux = [tiempoTransitorio,tiempoEstabilidad, tiempoMedicion]
        t_des = (aux * (cantidadPuntos)*2 ) + aux
        
    
    # Armamos la trayectoria / perfil de viento de referencia para el controlador
    # trajectoryVector = [0]*1000
    trajectoryVector = []
    idx = 0
    t_s = 1 # tiempo de muestreo en seg
    t_acc = 10 # tiempo de aceleracion en seg
    rapidez_max = 20 # pendiente maxima puede soportar el tunel, quiza tenga que ver con el saturador,255
    qA = velRef[0] # punto de partida
    for i in range(0,len(velRef)-1):
        qB = velRef[i] # donde iba
        qC = velRef[i+1] # donde voy
        dA = qA-qB # de la zona 1
        dC = qC-qB # de la zona 2
        # Tj = max([dC/rapidez_max,t_des[i]])
        Tj = t_des[i]
    
        for t_segm in range(-t_acc+t_s,t_acc,t_s): # zona 1  
            trajectoryVector.append((dC/Tj)*(((t_segm+t_acc)**2) /( 4*t_acc) ) + (dA/t_acc)*(((t_segm-t_acc)**2) / (4*t_acc)) + qB)  
            
        for t_segm in range(t_acc+t_s,Tj-t_acc+2,t_s): # zona 2
            trajectoryVector.append( (dC/Tj)*t_segm + qB)
            qA = trajectoryVector[idx-1]
    # Redondeamos a 3 decimales los elementos de referencia
    trajectoryVector = [round(numero, 3) for numero in trajectoryVector]
    # Crear un arreglo de 1 a idx
    t = np.arange(1, idx+1)
    # Multiplicar cada elemento por t_samplig
    t = t * t_s
    # Graficamos la trayectoria armada
    plt.plot(t/60,trajectoryVector )
    plt.xlabel('t')
    plt.ylabel('Vel Viento')
    plt.title('Grafico de t vs Vel Viento')
    plt.grid(True)
    plt.show()
    return trajectoryVector
\end{lstlisting}


\section{Comandos que enviar el software al datalogger}
\begin{table}[H]
\centering
\fontsize{10}{8}\selectfont
\begin{tblr}{
  row{1} = {Sail},
  row{6} = {Sail},
  row{11} = {Sail},
  row{16} = {Sail},
  column{2} = {c},
  cell{1}{1} = {c=2}{},
  cell{6}{1} = {c=2}{},
  cell{11}{1} = {c=2}{},
  cell{16}{1} = {c=2}{},
  hlines,
  vlines,
}
\textbf{Velocidad de viento}     &                                                                                           \\
Sensor                           & Ultrasonido                                                                               \\
Rango de Medición                & $\SI{0}{\meter\per\second}$ a $\SI{75}{\meter\per\second}$                                \\
Resolución                       & $\SI{0.1}{\meter\per\second}$                                                             \\                                 
Precisión                        & {$ \pm \SI{0.2}{\meter\per\second}$ o $2\%$ de la medición hasta $\SI{60}{\meter\per\second}$ \\ $3\%$ de la medición para mayor que $\SI{60}{\meter\per\second}$~}\\
\textbf{Dirección del viento}    &                                                                                           \\
Sensor                           & Ultrasonido                                                                               \\
Rango de Medición                & $\SI{0}{\degree}$ a $\SI{359.9}{\degree}$                                                \\
Resolución                       & $\SI{0.1}{\degree}$                                                                       \\
Precisión                        & $\pm \SI{2}{\degree} $ RMSE (velocidad del viento  $\SI{2}{\meter\per\second}$)           \\
\textbf{Fuente de alimentación}  &                                                                                           \\
Fuente de alimentación del calentador           & $\SI{24}{\volt}$ Vdc $\pm 10\%$\\
Consumo de energía del calentador               & $\SI{30}{\watt}$       \\
{Fuente de alimentación del\\ instrumento (sin calentador)}          & $\SI{12}{\volt}$ a $\SI{30}{\volt}$ Vdc\\
{Consumo de energía del\\ instrumento (sin calentador)}              & $\SI{60}{\milli\ampere}$ @ $\SI{24}{\volt}$ Vdc\\
\textbf{Otras especificaciones }    &                                                                                           \\
Salida Serial                       & RS232 aislado y  RS485                                                                      \\
Protocolo de comunicación           & NMEA, MODBUS-RTU, ACII propietario                                                               \\
Intervalo de medición               & Configurable de $\SI{250}{\milli\second}$ a $\SI{1}{\second}$\\
Intervalo de velocidad promedio     & Configurable de $\SI{1}{\second}$ a $\SI{10}{\minute}$\\
Conexión eléctrica                  & 19-pole M23 conector Macho\\
Temperatura de operación            & $\SI{-40}{\degreeCelsius}$ a $+\SI{70}{\degreeCelsius}$\\
Grado de protección                 &  IP66                                                                                         \\                                                                                 
\end{tblr}
\caption{.}
\label{tab:comandosParaconfig}
\end{table}